<% layout("/layouts/boilerplate") %>

<style>
/* FILTERS */
#filters{
  display: flex;
  flex-wrap: wrap;
  align-items: center;
}

.filter{
  text-align: center;
  margin-right: 2rem;
  margin-top: 2rem;
  opacity: 0.7;
}

.filter:hover{
  opacity: 1;
  cursor: pointer;
}

.filter p{
  font-size: 0.8rem;
}

/* GST */
.tax-info{
  display: none;
  color: green;
  font-weight: 500;
}

.tax-toggle{
  border: 1px solid black;
  border-radius: 1rem;
  height: 3.5rem;
  padding: 1rem;
  margin-top: 1rem;
  margin-left: 5rem;
  display: flex;
  align-items: center;
}

/* CARD */
.listing-card{
  height: 100%;
  transition: 0.2s ease;
  border-radius: 15px;
  overflow: hidden;
}

.listing-card:hover{
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
  transform: translateY(-3px);
}

.title-row{
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
}

.title-row b{
  display: -webkit-box;
  -webkit-line-clamp: 2;      
  -webkit-box-orient: vertical;
  overflow: hidden;
  line-height: 1.3rem;
  min-height: 2.6rem;         
}

.book-btn{
  white-space: nowrap;
  font-size: 0.75rem;
  padding: 0.35rem 0.7rem;
}

.listing-link{
  text-decoration: none;
  color: inherit;
}

/* ❤️ Wishlist */
.image-container {
  position: relative;
}

.wishlist-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: white;
  width: 38px;
  height: 38px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 3px 8px rgba(0,0,0,0.2);
  border: none;
  cursor: pointer;
  transition: 0.2s ease;
  z-index: 5;
}

.wishlist-btn i {
  font-size: 18px;
  color: #ff385c;
}

.wishlist-btn:hover {
  transform: scale(1.1);
}
</style>


<!-- ================= FILTER SECTION ================= -->
<div id="filters">

  <div class="filter">
    <a href="/listings?category=trending">
      <div><i class="fa-solid fa-fire"></i></div>
      <p>Trending</p>
    </a>
  </div>

  <div class="filter">
    <a href="/listings?category=rooms">
      <div><i class="fa-solid fa-bed"></i></div>
      <p>Rooms</p>
    </a>
  </div>

  <div class="filter">
    <a href="/listings?category=iconiccities">
      <div><i class="fa-solid fa-mountain-city"></i></div>
      <p>Iconic Cities</p>
    </a>
  </div>

  <div class="filter">
    <a href="/listings?category=mountains">
      <div><i class="fa-solid fa-mountain"></i></div>
      <p>Mountains</p>
    </a>
  </div>

  <div class="filter">
    <a href="/listings?category=castles">
      <div><i class="fa-solid fa-chess-rook"></i></div>
      <p>Castles</p>
    </a>
  </div>

  <div class="filter">
    <a href="/listings?category=pool">
      <div><i class="fa-solid fa-person-swimming"></i></div>
      <p>Pool</p>
    </a>
  </div>

  <div class="filter">
    <a href="/listings?category=camping">
      <div><i class="fa-solid fa-campground"></i></div>
      <p>Camping</p>
    </a>
  </div>

  <div class="filter">
    <a href="/listings?category=farms">
      <div><i class="fa-solid fa-tractor"></i></div>
      <p>Farms</p>
    </a>
  </div>

  <div class="filter">
    <a href="/listings?category=artic">
      <div><i class="fa-solid fa-snowflake"></i></div>
      <p>Artic</p>
    </a>
  </div>

  <!-- GST Toggle -->
  <div class="tax-toggle">
    <div class="form-check-reverse form-switch">
      <input class="form-check-input" type="checkbox" role="switch" id="switchCheckDefault">
      <label class="form-check-label" for="switchCheckDefault">
        Display total after taxes
      </label>
    </div>
  </div>

</div>


<!-- ================= LISTINGS ================= -->
<div class="row row-cols-lg-3 row-cols-md-2 row-cols-sm-1 mt-4">

  <% if (alllistings.length === 0) { %>
    <h3>No listings found</h3>
  <% } %>

  <% alllistings.forEach(list => { %>
    <div class="col mb-4">

      <div class="card listing-card h-100">

        <!-- IMAGE + HEART -->
        <div class="image-container">

          <a href="/listings/<%= list._id %>" class="listing-link">
            <img src="<%= list.image.url %>" class="card-img-top" alt="listing_image">
          </a>

          <% if(currUser){ %>
            <form action="/listings/<%= list._id %>/wishlist" method="POST">
              <button type="submit"
                      class="wishlist-btn"
                      onclick="event.stopPropagation();">

                <% if(currUser.wishlist && 
                     currUser.wishlist.some(id => id.toString() === list._id.toString())) { %>

                  <i class="fa-solid fa-heart"></i>

                <% } else { %>

                  <i class="fa-regular fa-heart"></i>

                <% } %>

              </button>
            </form>
          <% } %>

        </div>

        <!-- BODY -->
        <div class="card-body">
          <div class="title-row">
            <b><%= list.title %></b>
            <span class="btn btn-sm btn-danger book-btn">
              Book Now
            </span>
          </div>

          <p class="card-text mt-2">
            ₹<%= list.price?.toLocaleString("en-IN") || "N/A" %>/night
            <span class="tax-info">
              | Total: ₹<%= (list.price * 1.18).toLocaleString("en-IN") %>
            </span>
          </p>
        </div>

      </div>

    </div>
  <% }) %>

</div>


<!-- GST SCRIPT -->
<script>
  const taxSwitch = document.getElementById("switchCheckDefault");

  taxSwitch.addEventListener("click", () => {
    const taxinfo = document.getElementsByClassName("tax-info");

    for (let info of taxinfo) {
      info.style.display =
        info.style.display === "inline" ? "none" : "inline";
    }
  });
</script>
